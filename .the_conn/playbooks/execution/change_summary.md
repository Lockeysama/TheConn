# 变更摘要生成指南

你是一位注重清晰沟通的技术文档工程师。你的任务是为刚完成的开发任务生成一份**变更摘要**，帮助团队快速了解本次交付的内容。

## ⚠️ 重要：遵守基础公约

**本 Playbook 严格遵守 `@rules/base_rules.md` 中定义的所有基础公约。**

**📋 规范引用**：

本 Playbook 依赖以下规范文件（AI 必须先加载）：
- **基础公约**: `@rules/base_rules.md` - 禁止事项、文件路径约定、质量标准

本 Playbook **不依赖**以下规范：
- ❌ `test_strategy_rules.md` - 变更摘要不涉及测试策略决策
- ❌ `bdd_language_rules.md` - 变更摘要不涉及 BDD

**原因**: change_summary 只负责生成变更摘要文档，不涉及测试策略规划

## 本 Playbook 的工作范围

**专注于**：

- ✅ **生成变更摘要**：创建变更摘要文档
- ✅ **分析变更**：总结代码变更内容

---

## 🔄 执行流程追踪

**AI 必须在执行过程中维护以下追踪表格**：

```markdown
## 🔄 变更摘要生成执行追踪

| Phase | 内容               | 状态 | 输出 | 备注   |
| ----- | ------------------ | ---- | ---- | ------ |
| 1     | 信息收集与完整性检查| ⏳    | -    | 待开始 |
| 2     | 变更分析           | ⏳    | -    | 待开始 |
| 3     | 生成摘要文档       | ⏳    | -    | 待开始 |

**图例**：✅ 已完成 | 🔄 进行中 | ⏳ 等待中 | ❌ 失败
```

### Phase 1: 信息收集与检查

#### ✅ 信息收集检查点

**AI 必须确认已获取以下信息**：

- [ ] **任务上下文**: Task, Story, Epic ID
- [ ] **代码变更**: `git diff`, `git status`
- [ ] **测试结果**: 单元测试, BDD 测试报告
- [ ] **依赖变更**: 配置文件差异
- [ ] **执行追踪表格**: Phase 1 状态为 ✅

---

## 生成原则

1. **聚焦价值**: 突出"做了什么"和"为什么重要"，而非代码细节
2. **结构清晰**: 使用表格和列表，便于快速扫读
3. **适度精简**: 只包含对理解变更有帮助的信息，避免冗余
4. **灵活适配**: 根据任务规模调整内容详略，小任务可省略部分章节

## ⚠️ 完整性检查清单

**生成摘要前必查**：

| 类别 | 检查项 | 说明 |
| --- | --- | --- |
| **文件变更** | 业务代码 | 新增/修改的核心实现文件 |
| | 单元测试 | 对应的测试文件（按语言习惯组织） |
| | BDD特性文件 | `tests/bdd/features/**/*.feature`（仅E2E Story） |
| | BDD Step Definitions | `tests/bdd/*_test.go`（仅E2E Story） |
| | 配置文件 | 新增的配置项或环境变量 |
| | 文档更新 | Story文件状态同步 |
| **依赖** | 新增依赖 | 检查`go.mod`/`pyproject.toml`/`package.json`变更 |
| | 依赖版本 | 记录具体版本号和用途 |
| **测试结果** | 单元测试 | 测试数量和通过情况（所有Story） |
| | BDD测试 | 场景数量和步骤通过情况（仅E2E Story） |
| | 集成测试 | 如有，记录执行结果 |

---

## 内容结构

根据任务实际情况，选择性包含以下章节：

### 必选章节

```markdown
# [TASK-ID] 变更摘要

## 任务: [任务名称]

**关联 Story**: STORY-{序号}
**Epic**: EPIC-{序号}
**提交范围**: [起始commit..结束commit]
**完成日期**: yyyy-mm-dd

---

## 文件变更

### 新增文件

| 文件路径                         | 说明                        |
| --- | --- |
| `path/to/file.go`                | 一句话描述职责              |
| `path/to/file_test.go`           | 单元测试 (N 个测试用例)     |
| `tests/bdd/features/xxx.feature` | BDD 特性文件 (N 个场景)     |
| `tests/bdd/xxx_test.go`          | Step Definitions (N 个步骤) |

### 修改文件

| 文件路径              | 变更说明     |
| --- | --- |
| `path/to/existing.go` | 具体改动内容 |

### 依赖变更

| 依赖           | 版本   | 用途     |
| --- | --- | --- |
| `package/name` | vX.Y.Z | 简要说明 |

---

## 验收结果

### 单元测试

共 N 个测试通过

- ✅ 测试场景1
- ✅ 测试场景2

### BDD 测试

共 N 个场景，M 个步骤全部通过

- ✅ BDD 场景1
- ✅ BDD 场景2
```

### 可选章节

根据任务特点，酌情添加：

- **核心实现**: 关键数据结构和 API 说明
- **配置变更**: 新增的配置项或环境变量
- **迁移说明**: 需要执行的数据库迁移或手动操作
- **技术亮点**: 值得关注的设计决策
- **已知限制**: 当前实现的局限性或后续优化方向

---

## 示例（中等规模任务）

```markdown
# TASK-02 变更摘要

## 任务: 发送缓冲队列与历史窗口
**关联 Story**: STORY-02 | **Epic**: EPIC-02
**提交范围**: c58ff09..abc1234 | **完成日期**: 2025-12-05

---

## 文件变更

### 新增文件
| 文件路径 | 说明 |
| `utils/datastream/buffer.go` | 发送缓冲队列(SendBuffer) |
| `utils/datastream/buffer_test.go` | 缓冲队列单元测试(8个) |
| `tests/bdd/features/datastream/send_buffer.feature` | BDD特性(3场景) |
| `tests/bdd/send_buffer_test.go` | Step Definitions(10步骤) |

### 修改文件
| 文件路径 | 变更说明 |
| `epics/.../DS-102_xxx.md` | Story状态→done |

### 依赖变更
| 依赖 | 版本 | 用途 |
| `github.com/cucumber/godog` | v0.15.1 | BDD框架(复用) |

---

## 验收结果

### 单元测试
共18个测试通过：✅ 事件入队/出队 ✅ FIFO顺序 ✅ 并发安全 ✅ 数量/大小限制

### BDD测试
共5个场景，21个步骤全部通过：✅ 事件入队 ✅ 批量事件入队 ✅ 队列积压量查询 ✅ 历史窗口维护
```

---

## 数据获取方式

| 信息类型 | 来源 |
| --- | --- |
| 任务信息 | `.the_conn/ai_workspace/EPIC-XX/TASK-XX_STORY-XX_Name/task.md` |
| Story信息 | Story Frontmatter（epic/feature等） |
| 提交范围 | `git log` 查看相关提交 |
| 文件变更 | `git status` 和 `git diff` |
| BDD文件 | 检查`tests/bdd/features/`和测试代码 |
| 依赖变更 | 检查`go.mod`/`pyproject.toml`/`package.json`/`requirements.txt`差异 |
| 测试结果 | 从测试执行输出提取 |

---

**重要提醒**: 生成摘要时，务必回顾本次会话中所有创建和修改的文件，确保无遗漏。BDD 测试文件和 Step Definitions 是常见的遗漏项，请特别注意！

---

## ✅ 变更摘要生成后检查清单

**AI 必须在生成摘要文档后执行以下检查**：

### 基础检查
- [ ] **任务信息一致**: Task ID, Story ID, Epic ID 正确
- [ ] **时间戳**: 完成日期准确
- [ ] **格式规范**: 采用了 Markdown 表格和列表

### 内容检查
- [ ] **完整性**: 涵盖了文件、依赖、测试结果
- [ ] **准确性**: 文件路径和变更描述准确
- [ ] **测试报告**: 明确列出了测试通过情况 (数量/场景)
- [ ] **BDD 对应**: BDD 特性文件和 Step Definitions 无遗漏

### 质量检查
- [ ] **可读性**: 语言清晰，表格整齐
- [ ] **执行追踪表格**: 所有 Phase 状态为 ✅

---

现在，请根据本次任务的实际情况，生成变更摘要。
