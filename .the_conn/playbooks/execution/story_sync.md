你是一位严谨的技术文档工程师。你的任务是确保规划文档（Story/Feature/Epic）与最终的代码实现保持 100% 一致。

## ⚠️ 重要：遵守基础公约

**本 Playbook 严格遵守 `@rules/base_rules.md` 中定义的所有基础公约。**

**📋 规范引用**：

本 Playbook 依赖以下规范文件（AI 必须先加载）：
- **基础公约**: `@rules/base_rules.md` - 禁止事项、文件路径约定、质量标准

本 Playbook **不依赖**以下规范：
- ❌ `test_strategy_rules.md` - 同步不涉及测试策略决策
- ❌ `bdd_language_rules.md` - 同步不涉及 BDD 生成

**原因**: 此 Playbook 只负责同步已完成的实现到规划文档，不涉及测试策略规划

## 本 Playbook 的工作范围

**专注于**：

- ✅ **同步 Story/Feature/Epic 文档**：更新文档内容与实际实现保持一致
- ✅ **更新状态**：将 status 更新为 done（Story）或 in_progress/done（Feature/Epic）
- ✅ **更新进度统计**：更新 Feature/Epic 的 Story 完成统计

---

## 📋 速览（AI 快速决策）

### 同步路由决策

```mermaid
graph TD
    A[接收同步任务] --> B{文档类型?}
    B -->|Story| C[Story 同步流程]
    B -->|Feature| D[Feature 同步流程]
    B -->|Epic| E[Epic 同步流程]
    
    C --> C1[更新验收标准]
    C1 --> C2[更新涉及文件]
    C2 --> C3[更新 status=done]
    C3 --> F[✅ 完成]
    
    D --> D1[统计Story完成情况]
    D1 --> D2[更新进度百分比]
    D2 --> D3[更新测试里程碑]
    D3 --> D4[更新 status]
    D4 --> F
    
    E --> E1[统计Feature完成情况]
    E1 --> E2[更新Epic进度]
    E2 --> E3[更新测试里程碑]
    E3 --> E4[更新 status]
    E4 --> F
```

### Story 同步流程详解

```mermaid
graph LR
    A[读取原始Story] --> B[对比代码变更]
    B --> C{需要同步?}
    C -->|Frontmatter| D[更新 status/updated]
    C -->|验收标准| E[更新功能清单/BDD]
    C -->|涉及文件| F[更新文件列表]
    C -->|关键逻辑| G[更新实现描述]
    D --> H[✅ 输出Story]
    E --> H
    F --> H
    G --> H
    H --> I{设计变更?}
    I -->|是| J[输出Context同步建议]
    I -->|否| K[✅ 完成]
    J --> K
```

**关键点**：
- ✅ **可修改**：status, updated, 验收标准, 涉及文件, 关键逻辑, 进度统计
- ❌ **禁止修改**：id, type, epic, feature, created, depends_on, 目标描述
- ✅ **保持规划性质**：不改为"已创建"、"已实现"等过去式
- ✅ **Context 同步谨慎**：仅当设计真正变更时才建议同步

---

## 🚨 常见错误与解决方案

### Story 同步常见错误

| #     | 错误类型                | 错误表现                                         | 正确做法                                                | 为什么错误                           |
| ----- | ----------------------- | ------------------------------------------------ | ------------------------------------------------------- | ------------------------------------ |
| **1** | **修改 Story 身份字段** | 修改了 `id`、`epic`、`feature`、`created` 等字段 | **禁止修改**：这些是 Story 身份，不能改                 | 破坏 Story 追溯性和依赖关系          |
| **2** | **改为过去式**          | "需要创建" → "已创建"、"应该实现" → "已实现"     | **保持规划性质**：Story 是规划文档，不是变更日志        | Story 是需求文档，不是实施报告       |
| **3** | **修改目标描述**        | 改写了 "## 1. 目标" 章节的业务目标               | **禁止修改目标**：业务目标是 Story 核心，不能改         | 目标变更意味着这是另一个 Story       |
| **4** | **过度同步 Context**    | 任何小改动都建议同步 Context                     | **谨慎操作**：仅当设计真正变更时才建议同步              | Context 是设计文档，小改动不需要同步 |
| **5** | **未更新 status**       | 完成开发但 status 仍为 `in_progress`             | **必须更新**：status 更新为 `done`，添加 `updated` 日期 | Story 状态不一致，影响项目进度追踪   |

### Feature 同步常见错误

| #     | 错误类型             | 错误表现                             | 正确做法                                            | 为什么错误               |
| ----- | -------------------- | ------------------------------------ | --------------------------------------------------- | ------------------------ |
| **1** | **未统计所有 Story** | 只看部分 Story，进度计算错误         | **全面统计**：读取 `stories/` 下所有 Story 文件     | 进度不准确，误导项目管理 |
| **2** | **进度计算错误**     | 百分比计算错误（如 3/5 = 50%）       | **正确计算**：3/5 = 60%                             | 数据错误影响决策         |
| **3** | **过早标记 done**    | 还有 Story 未完成就标记 Feature done | **严格条件**：所有 Story done 才能标记 Feature done | 状态不一致，破坏依赖链   |
| **4** | **忘记测试里程碑**   | 未更新 E2E/性能测试 Story 状态       | **同步测试**：更新测试 Story 的状态列表             | 测试状态不清晰           |

### Epic 同步常见错误

| #     | 错误类型               | 错误表现                                  | 正确做法                                               | 为什么错误                   |
| ----- | ---------------------- | ----------------------------------------- | ------------------------------------------------------ | ---------------------------- |
| **1** | **未统计所有 Feature** | 只看部分 Feature，Epic 进度计算错误       | **全面统计**：读取 `features/` 下所有 Feature README   | 进度不准确                   |
| **2** | **嵌套进度错误**       | Feature 进度（Stories）未同步到 Epic 总览 | **两层统计**：Feature 完成度 + 每个 Feature 的 Stories | 缺少细节，无法追踪问题       |
| **3** | **过早标记 done**      | 还有 Feature 未完成就标记 Epic done       | **严格条件**：所有 Feature done 才能标记 Epic done     | 状态不一致，误导项目整体进度 |
| **4** | **忘记 Epic 测试**     | 未更新 Epic 级 E2E/性能测试里程碑         | **同步测试**：更新 Epic 测试 Story 的状态              | Epic 级测试状态不清晰        |

---

## 任务目标

根据文档类型，完成相应的同步任务：

### Story 同步目标

对比【原始 Story】和【最终代码变更】，完成以下同步：

1. 更新 Story 的技术细节，使其与实际实现精确对齐
2. 将 Story 状态标记为 `done`（任务完成后）
3. 如有需要，同步更新相关 Context 文档（谨慎操作）

### Feature 同步目标

统计【Feature 下所有 Story 状态】，完成以下同步：

1. 更新 Story 列表中的完成状态和进度百分比
2. 更新测试里程碑状态（E2E/性能测试）
3. 根据 Story 完成情况更新 Feature 状态（所有 done → Feature done）
4. 更新 `updated` 时间戳

### Epic 同步目标

统计【Epic 下所有 Feature 状态】，完成以下同步：

1. 更新 Feature 列表中的完成进度（Stories 数量和百分比）
2. 更新 Epic 总体进度统计
3. 更新 Epic 级测试里程碑状态
4. 根据 Feature 完成情况更新 Epic 状态（所有 done → Epic done）
5. 更新 `updated` 时间戳

---

## 更新规则

### 同步规则总览

| 文档类型 | 主要更新内容                     | 状态更新逻辑                  | 禁止修改                  |
| -------- | -------------------------------- | ----------------------------- | ------------------------- |
| Story    | 验收标准、涉及文件、关键逻辑     | `in_progress` → `done`        | id/type/epic/feature/目标 |
| Feature  | Story 进度统计、测试里程碑       | 所有 Story done 后 → `done`   | id/epic/目标/依赖关系     |
| Epic     | Feature 进度统计、整体测试里程碑 | 所有 Feature done 后 → `done` | id/目标/拆分逻辑          |

---

### Story 同步规则

#### 变更追踪机制 🆕

**AI 必须在同步前生成变更摘要**：

```markdown
## 📋 Story 同步变更摘要

**Story ID**: STORY-{ID}
**同步日期**: {yyyy-mm-dd}
**变更类型**: 增量同步 / 设计变更 / 大幅调整

### 变更详情

| 变更项   | 原内容       | 新内容         | 变更原因       |
| -------- | ------------ | -------------- | -------------- |
| status   | in_progress  | done           | 任务完成       |
| 涉及文件 | 3 个文件     | 6 个文件 (+3)  | 新增 API 文件  |
| 验收标准 | 场景 2 个    | 场景 3 个 (+1) | 补充边界测试   |
| 关键逻辑 | 使用同步调用 | 使用异步调用   | 性能优化       |
| 复杂度   | 3.5 分       | 4.0 分 (+0.5)  | 实际工作量增加 |

### 变更统计

- **新增内容**: 3 项
- **修改内容**: 2 项
- **删除内容**: 0 项
- **设计变更**: 否

**变更级别**: 🟢 轻微（仅状态和细节同步） / 🟡 中等（有实现差异） / 🔴 重大（设计变更）
```

#### 可以修改的部分

1. **Frontmatter 中的 `status` 和 `updated` 字段**:
   - ✅ **必须更新**: 任务完成后将 `status` 改为 `done`
   - ✅ **建议添加**: `updated: {yyyy-mm-dd}`（标记最后同步时间）
   - 格式示例:

     ```yaml
     status: done
     updated: 2025-12-11
     ```

2. **验收标准**:
   - **如果是 E2E Story (`type: e2e_test`)**: 更新 BDD 场景，确保与测试代码一致
   - **如果是普通 Story (`type: dev` 或 `bug_fix`)**: 更新功能清单，标记已完成的项
   - 确保预期结果与代码实现完全匹配

3. **实现指导 - 涉及文件**:
   - 根据实际创建/修改的文件更新列表
   - 删除未实际涉及的文件
   - 添加实际创建但原规划未提及的文件

4. **实现指导 - 关键逻辑**:
   - 如实际实现的算法/流程与原规划不同，更新描述
   - 补充原规划未涵盖但实际实现的关键点

#### 绝对禁止修改的部分

1. **Frontmatter 关键字段**: 不能修改 `id`, `type`, `epic`, `feature`, `created`, `depends_on`
2. **Story 目标**: 不能修改业务目标和价值描述（"## 1. 目标"章节）
3. **状态性表述**: 文档内容保持规划性质（如"需要创建"不改为"已创建"）

---

### Feature 同步规则

#### 进度趋势分析 🆕

**AI 必须在同步 Feature 前生成进度趋势分析**：

```markdown
## 📊 Feature 进度趋势分析

**Feature ID**: FEAT-{ID}
**同步日期**: {yyyy-mm-dd}
**上次同步**: {yyyy-mm-dd}（{N} 天前）

### 进度变化

| 日期       | 完成 Story | 进度 | 变化 | 本期完成的 Story   |
| ---------- | ---------- | ---- | ---- | ------------------ |
| 2025-12-15 | 2/5        | 40%  | +1   | STORY-02           |
| 2025-12-20 | 4/5        | 80%  | +2   | STORY-03, STORY-04 |
| 2025-12-25 | 5/5        | 100% | +1   | STORY-99 (E2E)     |

### 速度分析

**平均完成速度**: 1.0 Story/天
**预计剩余时间**: 0 天（已完成）
**是否延期**: 否

### 里程碑达成

| 里程碑          | 计划日期   | 实际日期   | 状态   |
| --------------- | ---------- | ---------- | ------ |
| 功能 Story 完成 | 2025-12-22 | 2025-12-20 | ✅ 提前 |
| E2E 测试完成    | 2025-12-25 | 2025-12-25 | ✅ 按时 |
| Feature 完成    | 2025-12-25 | 2025-12-25 | ✅ 按时 |

**总体评估**: 🟢 进展顺利，按时完成
```

#### 可以修改的部分

1. **Frontmatter 中的 `status` 和 `updated` 字段**:
   - ✅ **更新 status**:
     - 有 Story 完成时 → `in_progress`
     - 所有 Story 完成时 → `done`
   - ✅ **更新时间**: `updated: {yyyy-mm-dd}`
   - 格式示例:

     ```yaml
     status: done
     updated: 2025-12-11
     ```

2. **Story 进度统计**:
   - 更新"Story 列表"章节中的完成数量
   - 更新进度条/百分比
   - 示例:

     ```markdown
     ## 📋 Story 列表

     **进度**: 5/5 完成 (100%)

     | Story ID | Story 名称 | 类型 | 状态   | 复杂度 |
     | -------- | ---------- | ---- | ------ | ------ |
     | STORY-01 | 用户登录   | dev  | ✅ done | 3.5    |
     | STORY-02 | 密码重置   | dev  | ✅ done | 2.0    |
     ```

3. **测试里程碑状态**:
   - 更新 E2E 测试 Story 的完成状态
   - 更新性能测试 Story 的完成状态
   - 示例:

     ```markdown
     ## 🧪 测试里程碑

     | 测试类型 | Story ID | 状态   |
     | -------- | -------- | ------ |
     | E2E 测试 | STORY-99 | ✅ done |
     | 性能测试 | STORY-97 | ✅ done |
     ```

4. **Feature 总结**（可选）:
   - 补充实际实现中发现的关键点
   - 记录重要的技术决策

#### 绝对禁止修改的部分

1. **Frontmatter 关键字段**: 不能修改 `id`, `epic`, `created`, `depends_on`
2. **Feature 目标**: 不能修改业务目标和价值描述
3. **Story 拆分逻辑**: 不能修改 Story 的依赖关系和拆分逻辑（这是设计决策）

---

### Epic 同步规则

#### Epic 进度趋势分析 🆕

**AI 必须在同步 Epic 前生成多维度进度分析**：

```markdown
## 📊 Epic 进度趋势分析

**Epic ID**: EPIC-{ID}
**同步日期**: {yyyy-mm-dd}
**上次同步**: {yyyy-mm-dd}（{N} 天前）
**Epic 启动**: {yyyy-mm-dd}（已进行 {M} 天）

### Feature 级进度

| 日期       | 完成 Feature | 进度 | 变化 | 本期完成的 Feature |
| ---------- | ------------ | ---- | ---- | ------------------ |
| 2025-12-10 | 0/3          | 0%   | -    | -                  |
| 2025-12-20 | 1/3          | 33%  | +1   | FEAT-01 用户认证   |
| 2025-12-25 | 3/3          | 100% | +2   | FEAT-02, FEAT-03   |

### Story 级进度（嵌套）

| Feature  | 总 Story | 已完成 | 进度     | 状态       |
| -------- | -------- | ------ | -------- | ---------- |
| FEAT-01  | 5        | 5      | 100%     | ✅ done     |
| FEAT-02  | 3        | 3      | 100%     | ✅ done     |
| FEAT-03  | 2        | 2      | 100%     | ✅ done     |
| **合计** | **10**   | **10** | **100%** | **✅ done** |

### 复杂度追踪

| Feature  | 预估复杂度 | 实际复杂度 | 偏差     | 说明           |
| -------- | ---------- | ---------- | -------- | -------------- |
| FEAT-01  | 15.0       | 17.5       | +2.5     | 增加了边界处理 |
| FEAT-02  | 8.0        | 8.0        | 0        | 符合预期       |
| FEAT-03  | 5.0        | 6.5        | +1.5     | 增加了日志功能 |
| **合计** | **28.0**   | **32.0**   | **+4.0** | 偏差 +14%      |

### 速度分析

**平均完成速度**: 0.2 Feature/天（2.0 Story/天）
**实际用时**: 15 天
**预估用时**: 13 天
**是否延期**: 是（延期 2 天）

### 里程碑达成

| 里程碑        | 计划日期   | 实际日期   | 状态   | 偏差  |
| ------------- | ---------- | ---------- | ------ | ----- |
| FEAT-01 完成  | 2025-12-15 | 2025-12-20 | ⚠️ 延期 | +5 天 |
| FEAT-02 完成  | 2025-12-20 | 2025-12-22 | ⚠️ 延期 | +2 天 |
| FEAT-03 完成  | 2025-12-23 | 2025-12-25 | ⚠️ 延期 | +2 天 |
| Epic E2E 测试 | 2025-12-25 | 2025-12-25 | ✅ 按时 | 0     |

### 风险与问题回顾

| 类型 | 问题描述              | 发生时间   | 解决方案           | 状态     |
| ---- | --------------------- | ---------- | ------------------ | -------- |
| 延期 | FEAT-01 复杂度低估    | 2025-12-18 | 增加人力           | ✅ 已解决 |
| 依赖 | 第三方 API 文档不完整 | 2025-12-20 | 联系供应商获取文档 | ✅ 已解决 |
| 质量 | E2E 测试环境不稳定    | 2025-12-24 | 升级测试环境       | ✅ 已解决 |

### 总体评估

**进度状态**: 🟡 轻微延期（+2 天）
**质量状态**: 🟢 符合预期（测试通过率 98%）
**风险状态**: 🟢 无遗留风险
**团队状态**: 🟢 士气良好

**经验教训**:
- ✅ 复杂度评估需要更保守（实际偏差 +14%）
- ✅ 第三方依赖需提前确认文档完整性
- ✅ 测试环境稳定性是 E2E 测试的关键

**建议**:
- 下一个 Epic 的复杂度评估增加 15% 缓冲
- 依赖第三方服务的 Feature 提前 1 周确认集成方案
```

#### 可以修改的部分

1. **Frontmatter 中的 `status` 和 `updated` 字段**:
   - ✅ **更新 status**:
     - 有 Feature 完成时 → `in_progress`
     - 所有 Feature 完成时 → `done`
   - ✅ **更新时间**: `updated: {yyyy-mm-dd}`

2. **Feature 进度统计**:
   - 更新"Features 列表"章节中的完成数量和进度
   - 更新 Gantt 图或进度条
   - 示例:

     ```markdown
     ## 📦 Features 列表

     **总进度**: 3/3 完成 (100%)

     | Feature ID | Feature 名称 | Stories | 进度 | 状态   |
     | ---------- | ------------ | ------- | ---- | ------ |
     | FEAT-01    | 用户认证     | 5/5     | 100% | ✅ done |
     | FEAT-02    | 权限管理     | 3/3     | 100% | ✅ done |
     | FEAT-03    | 审计日志     | 2/2     | 100% | ✅ done |
     ```

3. **Epic 级测试里程碑**:
   - 更新 Epic E2E 测试状态
   - 更新 Epic 性能测试状态
   - 示例:

     ```markdown
     ## 🧪 Epic 测试里程碑

     | 测试类型      | Story ID  | 状态   |
     | ------------- | --------- | ------ |
     | Epic E2E      | STORY-999 | ✅ done |
     | Epic 性能测试 | STORY-997 | ✅ done |
     ```

4. **Epic 总结**（可选）:
   - 补充 Epic 完成后的整体评估
   - 记录关键成果和经验教训

#### 绝对禁止修改的部分

1. **Frontmatter 关键字段**: 不能修改 `id`, `created`
2. **Epic 目标和范围**: 不能修改 Epic 的业务目标和价值
3. **Feature 拆分逻辑**: 不能修改 Feature 的依赖关系和拆分逻辑

---

---

## Context 同步（谨慎操作）⚠️

### 何时需要同步 Context？

在以下情况下，需要考虑同步 Context：

1. **设计变更**: 实际实现与原 Context 描述的设计有本质差异
2. **接口变更**: API 签名、数据模型发生改变
3. **架构调整**: 模块结构、依赖关系改变
4. **新增关键逻辑**: 实现了原 Context 未提及的重要机制

### Context 同步原则

⚠️ **极度谨慎**: Context 是真相源，错误同步会误导后续开发

1. **只同步事实**: 仅更新确实需要修正的技术描述
2. **不同步微小细节**: 代码层面的小调整不需要反映到 Context
3. **不修改设计意图**: 如果实现偏离设计，应评估是实现问题还是设计问题
4. **需人工确认**: 建议同步 Context 的变更，但需用户明确确认后才执行

### Context 同步检查清单

| 检查项   | 问题                                           |
| -------- | ---------------------------------------------- |
| 影响范围 | 变更是否真的影响架构/设计？（vs 只是实现细节） |
| 原因分析 | 是实现偏离了设计，还是设计本身需要修正？       |
| 影响评估 | 如果不同步，会不会误导后续开发？               |
| 持久性   | 变更是临时的还是永久的？                       |

### Context 同步建议格式

如果判断需要同步 Context，输出建议：

```markdown
---
## ⚠️ Context 同步建议（含影响分析）

检测到以下 Context 可能需要更新：

### Context 1: Architecture.md

**变更类型**: 设计变更
**原描述**: 使用 REST API 进行通信
**实际实现**: 使用 gRPC 进行通信

**影响范围分析**:

| 影响类型 | 受影响对象                       | 影响程度 | 需要的操作       |
| -------- | -------------------------------- | -------- | ---------------- |
| 直接影响 | EPIC-02 订单模块（调用认证 API） | 🔴 高     | 修改接口调用代码 |
| 直接影响 | EPIC-03 支付模块（调用订单 API） | 🔴 高     | 修改接口调用代码 |
| 间接影响 | 测试框架（需支持 gRPC Mock）     | 🟡 中     | 更新测试工具链   |
| 文档影响 | API 文档（需更新通信协议说明）   | 🟢 低     | 更新文档         |

**风险评估**:
- **技术风险**: 中 - gRPC 引入新的依赖和学习成本
- **兼容性风险**: 高 - 需要修改所有 API 调用方
- **测试风险**: 中 - E2E 测试需要适配 gRPC
- **预估工作量**: 3-5 个 Story 需要修改

**建议优先级**: 🔴 P0（架构关键变更，必须立即同步）

**建议操作**:
1. 使用 @prompts/context/update.md 更新 Architecture.md 的"服务通信"章节
2. 通知相关 Epic 负责人（EPIC-02, EPIC-03）
3. 评估测试框架的适配工作量
4. 更新项目技术文档

---

### Context 2: Module_Design_Auth.md

**变更类型**: 接口变更
**原描述**: `login(username, password)` 返回 token
**实际实现**: `login(username, password)` 返回 `{token, expires_at}`

**影响范围分析**:

| 影响类型 | 受影响对象                      | 影响程度 | 需要的操作       |
| -------- | ------------------------------- | -------- | ---------------- |
| 直接影响 | STORY-04 会话管理（依赖 token） | 🟡 中     | 增加过期时间处理 |
| 直接影响 | 前端登录组件                    | 🟡 中     | 更新接口调用     |
| 间接影响 | 用户文档（登录说明）            | 🟢 低     | 更新文档         |

**风险评估**:
- **技术风险**: 低 - 向后兼容，仅增加字段
- **兼容性风险**: 低 - 旧代码可忽略 expires_at
- **测试风险**: 低 - 增加过期时间测试用例
- **预估工作量**: 1-2 个 Story 需要修改

**建议优先级**: 🟡 P1（接口增强，建议同步）

**建议操作**:
1. 使用 @prompts/context/update.md 更新 Module_Design_Auth.md 的 API 定义
2. 通知前端团队更新接口调用
3. 增加过期时间相关的测试用例

---

## 📊 影响分析总览

**总体风险评级**: 🔴 高（有 P0 级变更）

**受影响范围**:
- Epic: 2 个（EPIC-02, EPIC-03）
- Story: 4-7 个（预估）
- Context: 2 个（Architecture.md, Module_Design_Auth.md）

**建议执行顺序**:
1. ✅ 立即同步 Context（P0 优先）
2. ✅ 评估受影响 Story 的工作量
3. ✅ 通知相关团队成员
4. ✅ 更新测试框架和文档
5. ✅ 安排修复 Story 的开发

---

**请用户确认后，再执行 Context 更新操作。**
```

---

## 输出格式

### 主要输出

直接输出更新后的**完整 Story 文件内容**（包括 frontmatter），不要添加任何额外解释或说明。

### 可选输出（如需要）

如果检测到 Context 同步需求，在 Story 内容之后，另起一节输出"Context 同步建议"。

---

## 精确对齐要求

1. **BDD 场景**:
   - 场景步骤描述与测试代码一致
   - 预期结果的具体值（错误信息、状态码等）完全匹配

2. **文件路径**:
   - 使用实际创建的文件路径
   - 路径格式与项目结构一致

3. **技术术语**:
   - 使用代码中实际的类名、函数名、变量名
   - 保持术语的准确性和一致性

---

## 数据获取方式

| 数据类型     | 来源                                                                                                                                                    |
| ------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 原始 Story   | 上下文或路径：`.the_conn/epics/EPIC-XX_Name/features/FEAT-XX_Name/stories/STORY-XX_Name.md`                                                             |
| 原始 Feature | 上下文或路径：`.the_conn/epics/EPIC-XX_Name/features/FEAT-XX_Name/README.md`                                                                            |
| 原始 Epic    | 上下文或路径：`.the_conn/epics/EPIC-XX_Name/README.md`                                                                                                  |
| 最终变更代码 | • `git diff <start-commit> <end-commit>`<br/>• `git log -p -1`<br/>• 变更摘要：`.the_conn/ai_workspace/EPIC-XX/TASK-XX_STORY-XX_Name/change_summary.md` |
| Story 状态   | 读取同一 Feature 下所有 Story 文件的 `status` 字段                                                                                                      |
| Feature 状态 | 读取同一 Epic 下所有 Feature 的 README 文件的 `status` 字段                                                                                             |

---

## 示例

### 示例 1: 基础同步

#### 原始 Story 片段

```markdown
---
id: STORY-01
type: dev
epic: EPIC-01
feature: FEAT-01
status: pending
created: 2025-12-11
depends_on: []
---

## 2. 验收标准

功能: 项目结构初始化

  Scenario: 执行初始化命令
    Given 目标目录为空
    When 用户执行 `theconn init` 命令
    Then 应该创建 `.the_conn/` 目录
    And 应该返回成功消息
```

#### 代码实现发现

- 实际返回消息是: "Initialization completed successfully"
- 实际还创建了 `pyproject.toml` 文件

#### 同步后的 Story

```markdown
---
id: STORY-01
type: dev
epic: EPIC-01
feature: FEAT-01
status: done
created: 2025-12-11
updated: 2025-12-11
depends_on: []
---

## 2. 验收标准

功能: 项目结构初始化

  Scenario: 执行初始化命令
    Given 目标目录为空
    When 用户执行 `theconn init` 命令
    Then 应该创建 `.the_conn/` 目录
    And 应该创建 `pyproject.toml` 文件
    And 应该返回消息 "Initialization completed successfully"
```

---

### 示例 2: 含Context同步建议

**发现**: Story描述REST API，实际实现为gRPC（架构重大变更）

**同步后Story**（内容省略）+ **Context同步建议**：

```markdown
## ⚠️ Context 同步建议

### Context: Architecture.md
**变更类型**: 架构调整
**原描述**: "服务间使用 REST API 通信"
**实际实现**: 服务间使用 gRPC 通信
**影响**: 后续服务集成需基于 gRPC 设计
**建议**: 使用 @prompts/context/update.md 更新 Architecture.md 的"服务通信"章节

**请用户确认后，再执行 Context 更新操作。**
```

---

### 示例 3: Feature 同步

#### 场景
Feature 下所有 Story 均已完成，需要同步 Feature 状态

#### 原始 Feature README 片段

```markdown
---
id: FEAT-01
epic: EPIC-01
status: in_progress
created: 2025-12-10
updated: 2025-12-11
---

## 📋 Story 列表

**进度**: 2/5 完成 (40%)

| Story ID | Story 名称   | 类型     | 状态          | 复杂度 |
| -------- | ------------ | -------- | ------------- | ------ |
| STORY-01 | 用户登录     | dev      | ✅ done        | 3.5    |
| STORY-02 | 密码重置     | dev      | ✅ done        | 2.0    |
| STORY-03 | 邮箱验证     | dev      | 🚧 in_progress | 2.5    |
| STORY-04 | 会话管理     | dev      | ⏸️ pending     | 3.0    |
| STORY-99 | E2E 认证流程 | e2e_test | ⏸️ pending     | 4.0    |
```

#### 同步后的 Feature README

```markdown
---
id: FEAT-01
epic: EPIC-01
status: done
created: 2025-12-10
updated: 2025-12-25
---

## 📋 Story 列表

**进度**: 5/5 完成 (100%)

| Story ID | Story 名称   | 类型     | 状态   | 复杂度 |
| -------- | ------------ | -------- | ------ | ------ |
| STORY-01 | 用户登录     | dev      | ✅ done | 3.5    |
| STORY-02 | 密码重置     | dev      | ✅ done | 2.0    |
| STORY-03 | 邮箱验证     | dev      | ✅ done | 2.5    |
| STORY-04 | 会话管理     | dev      | ✅ done | 3.0    |
| STORY-99 | E2E 认证流程 | e2e_test | ✅ done | 4.0    |

## 🧪 测试里程碑

| 测试类型 | Story ID | 状态   |
| -------- | -------- | ------ |
| E2E 测试 | STORY-99 | ✅ done |
```

---

### 示例 4: Epic 同步

#### 场景
Epic 下所有 Feature 均已完成，需要同步 Epic 状态

#### 原始 Epic README 片段

```markdown
---
id: EPIC-01
status: in_progress
created: 2025-12-01
updated: 2025-12-15
---

## 📦 Features 列表

**总进度**: 1/3 完成 (33%)

| Feature ID | Feature 名称 | Stories | 进度 | 状态          |
| ---------- | ------------ | ------- | ---- | ------------- |
| FEAT-01    | 用户认证     | 3/5     | 60%  | 🚧 in_progress |
| FEAT-02    | 权限管理     | 0/3     | 0%   | ⏸️ pending     |
| FEAT-03    | 审计日志     | 0/2     | 0%   | ⏸️ pending     |
```

#### 同步后的 Epic README

```markdown
---
id: EPIC-01
status: done
created: 2025-12-01
updated: 2025-12-25
---

## 📦 Features 列表

**总进度**: 3/3 完成 (100%)

| Feature ID | Feature 名称 | Stories | 进度 | 状态   |
| ---------- | ------------ | ------- | ---- | ------ |
| FEAT-01    | 用户认证     | 5/5     | 100% | ✅ done |
| FEAT-02    | 权限管理     | 3/3     | 100% | ✅ done |
| FEAT-03    | 审计日志     | 2/2     | 100% | ✅ done |

## 🧪 Epic 测试里程碑

| 测试类型 | Story ID  | 状态   |
| -------- | --------- | ------ |
| Epic E2E | STORY-999 | ✅ done |
```

---

## 快速自检清单

### Story 同步自检

AI 在同步 Story 前必须检查：

- [ ] 我**生成了变更摘要**（变更项、原内容、新内容、变更原因）🆕
- [ ] 我**只修改了可修改部分**（status, updated, 验收标准, 涉及文件, 关键逻辑）
- [ ] 我**没有修改 Story 身份字段**（id, epic, feature, created, depends_on）
- [ ] 我**没有修改目标描述**（"## 1. 目标" 章节）
- [ ] 我**保持了规划性质**（未改为"已创建"、"已实现"等过去式）
- [ ] 如果设计真正变更，我**输出了 Context 同步建议含影响分析**（极度谨慎）🆕

### Feature 同步自检

AI 在同步 Feature 前必须检查：

- [ ] 我**生成了进度趋势分析**（进度变化、速度分析、里程碑达成）🆕
- [ ] 我**读取了所有 Story 的状态**（从 Feature 目录下的 stories/ 文件夹）
- [ ] 我**正确计算了进度百分比**（已完成数 / 总数 × 100%）
- [ ] 我**更新了 Story 列表中的状态**（✅ done / 🚧 in_progress / ⏸️ pending）
- [ ] 我**更新了测试里程碑状态**（E2E/性能测试 Story）
- [ ] 我**正确设置了 Feature status**（所有 Story done → done）
- [ ] 我**没有修改 Feature 身份字段**（id, epic, created, depends_on）
- [ ] 我**没有修改目标和拆分逻辑**

### Epic 同步自检

AI 在同步 Epic 前必须检查：

- [ ] 我**生成了多维度进度分析**（Feature/Story 进度、复杂度追踪、风险回顾）🆕
- [ ] 我**读取了所有 Feature 的状态**（从 Epic 目录下的 features/ 文件夹）
- [ ] 我**正确计算了 Epic 总进度**（已完成 Feature 数 / 总 Feature 数）
- [ ] 我**更新了 Feature 列表中的进度**（Stories 完成数和百分比）
- [ ] 我**更新了 Epic 测试里程碑**（Epic E2E/性能测试 Story）
- [ ] 我**正确设置了 Epic status**（所有 Feature done → done）
- [ ] 我**没有修改 Epic 身份字段**（id, created）
- [ ] 我**没有修改目标和拆分逻辑**

---

现在，请根据文档类型（Story/Feature/Epic）分析并更新文件内容。
