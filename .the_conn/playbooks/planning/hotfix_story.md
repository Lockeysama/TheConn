# Hotfix Story 生成指南

你是一位注重效率的开发工程师。你的任务是根据分析结果，生成精简但完整的 Hotfix Story 文件。

## ⚠️ 重要：遵守基础公约

**本 Playbook 严格遵守 `@rules/base_rules.md` 中定义的所有基础公约。**

**📋 规范引用**：

本 Playbook 依赖以下规范文件（AI 必须先加载）：
- **基础公约**: `@rules/base_rules.md` - 禁止事项、文件路径约定、质量标准

## 本 Playbook 的工作范围

**专注于**：
- ✅ 生成 Hotfix Story 文档
- ✅ 简化但保留关键要素（依赖、边界、技术要点）
- ✅ 快速验收标准

**不包括**：
- ❌ 不需要根因分析（与 bug_fix 的核心区别）
- ❌ 不需要伪代码示例（Hotfix 足够简单）
- ❌ 不需要长期改进计划（Hotfix 是直接改进）

---

## 🔄 执行流程追踪

**AI 必须在执行过程中维护以下追踪表格**：

```markdown
## 🔄 Hotfix 生成执行追踪

| Phase | 内容               | 状态 | 输出 | 备注   |
| ----- | ------------------ | ---- | ---- | ------ |
| 1     | 变更分析           | ⏳    | -    | 待开始 |
| 2     | 策略设计           | ⏳    | -    | 待开始 |
| 3     | 生成 Story 文档    | ⏳    | -    | 待开始 |

**图例**：✅ 已完成 | 🔄 进行中 | ⏳ 等待中 | ❌ 失败
```

### Phase 1 & 2: 分析与策略

#### ✅ 分析与策略检查点

**AI 必须确认以下项目后才能进入文档生成**：

- [ ] **场景确认**: 符合 Hotfix 使用场景 (非 Bug，仅仅是改进)
- [ ] **复杂度假定**: 确认复杂度 ≤ 2.0 分
- [ ] **依赖分析**: 已明确父 Story 或相关模块依赖
- [ ] **执行追踪表格**: Phase 1 & 2 状态为 ✅

---

## 使用场景

当以下情况发生时，应使用此模板：

1. 功能正常但需要小的改进
2. 新增简单的小功能（复杂度 ≤ 2 分）
3. 配置调整、参数优化
4. 代码重构、性能优化
5. 日志增强、监控改进
6. 文档更新

**与 bug_fix 的区别**：
- bug_fix: 功能**不正常**（需要修复）
- hotfix: 功能**正常**（需要改进）

---

## 输入

从 `quick_router.md` 或用户直接调用接收：
- Story ID: STORY-XX 或 STORY-XX.Y
- 父 Story ID: STORY-XX (如果有)
- Epic: EPIC-XX
- Feature: FEAT-XX
- 目标描述

---

## 输出要求

### 1. 文件路径

**如果有父 Story** (子 Story):
```
.the_conn/epics/EPIC-{序号}_{Name}/features/FEAT-{序号}_{Name}/stories/STORY-{父序号}.{子序号}_{PascalCaseName}.md
```

**如果无父 Story** (独立 Story):
```
.the_conn/epics/EPIC-{序号}_{Name}/features/FEAT-{序号}_{Name}/stories/STORY-{序号}_{PascalCaseName}.md
```

### 2. ID 命名规则

**子 Story** (属于某个已完成的 Story):
- **格式**: `STORY-{父序号}.{子序号}`
- **示例**: `STORY-03.1`, `STORY-03.2`, `STORY-05.1`

**独立 Story** (不属于任何现有 Story):
- **格式**: `STORY-{序号}`
- **示例**: `STORY-04`, `STORY-05`, `STORY-10`

### 3. 文件命名规则

**子 Story**:
- **格式**: `STORY-{父序号}.{子序号}_Hotfix_{PascalCaseName}.md`
- **示例**: `STORY-03.1_Hotfix_LoginLogs.md`

**独立 Story**:
- **格式**: `STORY-{序号}_{PascalCaseName}.md`
- **示例**: `STORY-04_Global_Request_Logger.md`

---

## 输出格式

```markdown
---
id: STORY-{序号} 或 STORY-{父序号}.{子序号}
type: hotfix
epic: EPIC-{序号}
feature: FEAT-{序号}
status: pending
created: yyyy-mm-dd
depends_on: [STORY-{父序号}] 或 []
---

# Story: {简短描述}

## 1. 目标

用 1-2 句话描述要做什么，为什么需要。从业务/用户价值角度说明。

## 2. 验收标准（功能清单）

完成以下功能要求：

- [ ] {功能要求1，如"增加登录成功/失败的详细日志"}
- [ ] {功能要求2，如"日志包含用户ID、IP地址、时间戳"}
- [ ] {功能要求3，如"日志格式符合统一标准"}
- [ ] {质量要求，如"单元测试覆盖率 ≥ 70%"（根据模块类型）}
- [ ] {质量要求，必须："所有测试通过，代码通过 linter 检查"}

**测试覆盖率要求**：
- 核心业务逻辑：≥ 80%
- 工具函数/辅助模块：≥ 70%
- UI 组件：≥ 60%
- 配置/常量：可选

**验证方式**：
- 运行单元测试，确保所有测试通过
- 检查测试覆盖率报告
- 手动验证关键功能点（如配置生效、日志输出等）
- Code Review 确认代码质量

## 3. 实现指导

**复杂度评估**: {1.0-2.0 分}（Hotfix 自动限定在此范围）

**评分参考**:
- 1.0-1.5 分：简单配置、日志添加、文档更新
- 1.6-2.0 分：小功能添加、简单优化、代码重构

**涉及文件**:
- `{文件路径}` - {说明}
- `{文件路径}` - {说明}

**关键逻辑**:
- {简要说明修改思路，1-3 条}
- {如果是配置调整，说明配置项的含义和影响}
- {如果是性能优化，说明优化点}

**依赖分析**:
- 依赖的 Story: {如果 depends_on 不为空}
- 依赖的模块: {如有外部模块依赖}
- 外部依赖: {如需要新的第三方库}

**边界**:
- 禁止修改: {明确范围，避免改动扩散}
- 接口约束: {如有接口约束}

**技术要点**:
- {关键的技术说明，1-3 条}
- {注意事项}
- {如果涉及配置，说明配置的默认值和可选值}
```

---

## Frontmatter 字段说明

**所有字段均为必填！**

| 字段         | 类型   | 说明                     | 示例                     |
| --- | --- | --- | --- |
| `id`         | string | Story ID                 | `STORY-04` 或 `STORY-03.1` |
| `type`       | enum   | 固定为 `hotfix`          | `hotfix`                 |
| `epic`       | string | 所属 Epic ID             | `EPIC-03`                |
| `feature`    | string | 所属 Feature ID          | `FEAT-02`                |
| `status`     | enum   | 状态                     | `pending` 或 `done`      |
| `created`    | date   | 创建日期                 | `2025-12-22`             |
| `depends_on` | array  | 依赖的 Story ID 列表     | `[]` 或 `[STORY-03]`     |

**字段约束**:
- `type`: 只能是 `hotfix`
- `status`: 只能是 `pending` 或 `done`
- `created`: 格式必须是 `yyyy-mm-dd`
- `depends_on`: 如果有父 Story，必须包含父 Story ID；如无依赖，必须写 `[]`

---

## 生成原则

1. **目标清晰**: 目标描述简洁，说明"为什么"和"价值是什么"
2. **清单具体**: 功能清单可验证、可测试
3. **范围明确**: 涉及文件和边界清晰
4. **单一职责**: 一个 Hotfix 只做一件小事
5. **简化但不简陋**: 虽然精简，但关键要素（依赖、边界、技术要点）必须保留
6. **快速验收**: 验收标准明确，测试要求清晰
7. **复杂度控制**: 严格限制在 1.0-2.0 分，超过则应该用标准 Story

---

## 示例速查

| # | 场景 | ID格式 | 目标 | 验收标准（核心）| 涉及文件 | 复杂度 |
|---| --- | --- | --- | --- | --- | --- |
| **1** | 子Story<br/>日志增强 | STORY-03.1 | 给登录功能增加详细日志 | • 记录成功/失败日志<br/>• 包含UserID/IP/时间<br/>• 格式符合标准 | `auth.py`<br/>`test_auth.py` | 1.5分 |
| **2** | 子Story<br/>性能优化 | STORY-07.1 | 优化数据查询性能 | • 查询响应<200ms<br/>• 增加缓存机制<br/>• 单元测试覆盖≥70% | `query.py`<br/>`cache.py` | 2.0分 |
| **3** | 独立Story<br/>配置调整 | STORY-96 | 增加配置热重载功能 | • 支持SIGHUP信号<br/>• 不中断服务<br/>• 记录重载日志 | `config.py`<br/>`signal.py` | 1.8分 |
| **4** | 独立Story<br/>小功能 | STORY-97 | 增加全局请求日志中间件 | • 自动记录请求<br/>• 包含URL/Method/Status<br/>• 可配置过滤规则 | `middleware.py`<br/>`test_middleware.py` | 1.5分 |

**关键差异**：
- **子Story**: `depends_on: [STORY-XX]` | 文件名: `STORY-XX.Y_Hotfix_Name.md`
- **独立Story**: `depends_on: []` | 文件名: `STORY-XX_Name.md`

**统一模板**（根据上表填充）：
```markdown
---
id: {ID格式}
type: hotfix
status: pending
depends_on: {子Story:[父ID] | 独立:[]}
---
# Story: {目标简述}
## 1. 目标
{1-2句话：做什么+为什么}
## 2. 验收标准
{核心功能清单+测试覆盖率+质量要求}
## 3. 实现指导
复杂度: {1.0-2.0分} | 涉及文件 | 关键逻辑 | 依赖/边界
```

---

## 注意事项

### 关于测试

**本 Playbook 生成的 Hotfix Story 使用单元测试验证**：

- ✅ 每个 Hotfix 应该规划单元测试
- ✅ 在功能清单中明确测试覆盖率要求
- ❌ 不使用 BDD 场景（BDD 用于 E2E Story）

### 关于复杂度

如果评估发现复杂度 > 2.0 分，应该：
1. 提示用户："该变更复杂度较高，建议创建标准 Story"
2. 询问用户是否继续创建 Hotfix 或改用标准 Story
3. 如果用户坚持，可以创建但在文档中注明风险

### 复杂度熔断机制 🔴

**如果在编写过程中发现复杂度不得不超过 2.0 分**：
1. **立即停止生成**。
2. 告知用户："该任务复杂度超出 Hotfix 范畴（>2.0），为保证质量，建议转为标准 Dev Story。"
3. 询问是否切换模式。

### 关于依赖和边界

即使是简单的 Hotfix，也必须明确：
- **依赖关系**：避免遗漏依赖导致无法执行
- **修改边界**：避免改动扩散影响其他模块
- **技术要点**：关键的注意事项，避免引入新问题

这些是质量保证的关键要素，不能省略。

---

## ✅ Hotfix Story 生成后检查清单

**AI 必须在生成 Story 文档后执行以下检查**：

### 基础检查
- [ ] **文件路径正确**: 区分了子 Story 和独立 Story 的路径
- [ ] **ID 格式正确**: `STORY-{父序号}.{子序号}` 或 `STORY-{序号}`
- [ ] **Type 正确**: 固定为 `hotfix`
- [ ] **Depends On**: 明确了依赖关系

### 内容检查
- [ ] **目标清晰**: 一句话说明价值
- [ ] **功能清单**: 包含具体可测的功能点
- [ ] **测试覆盖率**: 明确了覆盖率要求
- [ ] **复杂度评估**: 分数在 1.0-2.0 之间

### 质量检查
- [ ] **范围控制**: 仅包含本次改进，无无关变更
- [ ] **边界清晰**: 明确了禁止修改的范围
- [ ] **执行追踪表格**: 所有 Phase 状态为 ✅

---

现在，请根据用户提供的信息或 quick_router.md 传递的信息，生成 Hotfix Story。

