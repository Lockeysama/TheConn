# Hotfix Story 生成指南

你是一位注重效率的开发工程师。你的任务是根据分析结果，生成精简但完整的 Hotfix Story 文件。

## ⚠️ 重要：遵守基础公约

**本 Playbook 严格遵守 `@rules/base_rules.md` 中定义的所有基础公约。**

**📋 规范引用**：

本 Playbook 依赖以下规范文件（AI 必须先加载）：
- **基础公约**: `@rules/base_rules.md` - 禁止事项、文件路径约定、质量标准

## 本 Playbook 的工作范围

**专注于**：
- ✅ 生成 Hotfix Story 文档
- ✅ 简化但保留关键要素（依赖、边界、技术要点）
- ✅ 快速验收标准

**不包括**：
- ❌ 不需要根因分析（与 bug_fix 的核心区别）
- ❌ 不需要伪代码示例（Hotfix 足够简单）
- ❌ 不需要长期改进计划（Hotfix 是直接改进）

---

## 使用场景

当以下情况发生时，应使用此模板：

1. 功能正常但需要小的改进
2. 新增简单的小功能（复杂度 ≤ 2 分）
3. 配置调整、参数优化
4. 代码重构、性能优化
5. 日志增强、监控改进
6. 文档更新

**与 bug_fix 的区别**：
- bug_fix: 功能**不正常**（需要修复）
- hotfix: 功能**正常**（需要改进）

---

## 输入

从 `quick_router.md` 或用户直接调用接收：
- Story ID: STORY-XX 或 STORY-XX.Y
- 父 Story ID: STORY-XX (如果有)
- Epic: EPIC-XX
- Feature: FEAT-XX
- 目标描述

---

## 输出要求

### 1. 文件路径

**如果有父 Story** (子 Story):
```
.the_conn/epics/EPIC-{序号}_{Name}/features/FEAT-{序号}_{Name}/stories/STORY-{父序号}.{子序号}_{PascalCaseName}.md
```

**如果无父 Story** (独立 Story):
```
.the_conn/epics/EPIC-{序号}_{Name}/features/FEAT-{序号}_{Name}/stories/STORY-{序号}_{PascalCaseName}.md
```

### 2. ID 命名规则

**子 Story** (属于某个已完成的 Story):
- **格式**: `STORY-{父序号}.{子序号}`
- **示例**: `STORY-03.1`, `STORY-03.2`, `STORY-05.1`

**独立 Story** (不属于任何现有 Story):
- **格式**: `STORY-{序号}`
- **示例**: `STORY-04`, `STORY-05`, `STORY-10`

### 3. 文件命名规则

**子 Story**:
- **格式**: `STORY-{父序号}.{子序号}_Hotfix_{PascalCaseName}.md`
- **示例**: `STORY-03.1_Hotfix_LoginLogs.md`

**独立 Story**:
- **格式**: `STORY-{序号}_{PascalCaseName}.md`
- **示例**: `STORY-04_Global_Request_Logger.md`

---

## 输出格式

```markdown
---
id: STORY-{序号} 或 STORY-{父序号}.{子序号}
type: hotfix
epic: EPIC-{序号}
feature: FEAT-{序号}
status: pending
created: yyyy-mm-dd
depends_on: [STORY-{父序号}] 或 []
---

# Story: {简短描述}

## 1. 目标

用 1-2 句话描述要做什么，为什么需要。从业务/用户价值角度说明。

## 2. 验收标准（功能清单）

完成以下功能要求：

- [ ] {功能要求1，如"增加登录成功/失败的详细日志"}
- [ ] {功能要求2，如"日志包含用户ID、IP地址、时间戳"}
- [ ] {功能要求3，如"日志格式符合统一标准"}
- [ ] {质量要求，如"单元测试覆盖率 ≥ 70%"（根据模块类型）}
- [ ] {质量要求，必须："所有测试通过，代码通过 linter 检查"}

**测试覆盖率要求**：
- 核心业务逻辑：≥ 80%
- 工具函数/辅助模块：≥ 70%
- UI 组件：≥ 60%
- 配置/常量：可选

**验证方式**：
- 运行单元测试，确保所有测试通过
- 检查测试覆盖率报告
- 手动验证关键功能点（如配置生效、日志输出等）
- Code Review 确认代码质量

## 3. 实现指导

**复杂度评估**: {1.0-2.0 分}（Hotfix 自动限定在此范围）

**评分参考**:
- 1.0-1.5 分：简单配置、日志添加、文档更新
- 1.6-2.0 分：小功能添加、简单优化、代码重构

**涉及文件**:
- `{文件路径}` - {说明}
- `{文件路径}` - {说明}

**关键逻辑**:
- {简要说明修改思路，1-3 条}
- {如果是配置调整，说明配置项的含义和影响}
- {如果是性能优化，说明优化点}

**依赖分析**:
- 依赖的 Story: {如果 depends_on 不为空}
- 依赖的模块: {如有外部模块依赖}
- 外部依赖: {如需要新的第三方库}

**边界**:
- 禁止修改: {明确范围，避免改动扩散}
- 接口约束: {如有接口约束}

**技术要点**:
- {关键的技术说明，1-3 条}
- {注意事项}
- {如果涉及配置，说明配置的默认值和可选值}
```

---

## Frontmatter 字段说明

**所有字段均为必填！**

| 字段         | 类型   | 说明                     | 示例                     |
| ------------ | ------ | ------------------------ | ------------------------ |
| `id`         | string | Story ID                 | `STORY-04` 或 `STORY-03.1` |
| `type`       | enum   | 固定为 `hotfix`          | `hotfix`                 |
| `epic`       | string | 所属 Epic ID             | `EPIC-03`                |
| `feature`    | string | 所属 Feature ID          | `FEAT-02`                |
| `status`     | enum   | 状态                     | `pending` 或 `done`      |
| `created`    | date   | 创建日期                 | `2025-12-22`             |
| `depends_on` | array  | 依赖的 Story ID 列表     | `[]` 或 `[STORY-03]`     |

**字段约束**:
- `type`: 只能是 `hotfix`
- `status`: 只能是 `pending` 或 `done`
- `created`: 格式必须是 `yyyy-mm-dd`
- `depends_on`: 如果有父 Story，必须包含父 Story ID；如无依赖，必须写 `[]`

---

## 生成原则

1. **目标清晰**: 目标描述简洁，说明"为什么"和"价值是什么"
2. **清单具体**: 功能清单可验证、可测试
3. **范围明确**: 涉及文件和边界清晰
4. **单一职责**: 一个 Hotfix 只做一件小事
5. **简化但不简陋**: 虽然精简，但关键要素（依赖、边界、技术要点）必须保留
6. **快速验收**: 验收标准明确，测试要求清晰
7. **复杂度控制**: 严格限制在 1.0-2.0 分，超过则应该用标准 Story

---

## 示例

### 示例 1: 子 Story - 日志增强

```markdown
---
id: STORY-03.1
type: hotfix
epic: EPIC-02
feature: FEAT-01
status: pending
created: 2025-12-22
depends_on:
  - STORY-03
---

# Story: 增加登录详细日志

## 1. 目标

增加用户登录过程的详细日志，提升系统可观测性，便于问题排查和安全审计。

## 2. 验收标准（功能清单）

完成以下功能要求：

- [ ] 记录每次登录尝试（成功和失败）
- [ ] 日志包含：用户ID、用户名、IP地址、时间戳、登录结果
- [ ] 登录失败时记录失败原因（密码错误、账号锁定等）
- [ ] 日志格式符合公司统一标准（JSON 格式）
- [ ] 单元测试覆盖率 ≥ 70%
- [ ] 所有测试通过，代码通过 linter 检查

**验证方式**：
- 运行单元测试
- 手动登录测试，检查日志输出
- 验证日志格式符合标准

## 3. 实现指导

**复杂度评估**: 1.5 分

**涉及文件**:
- `src/auth/login.go` - 添加日志记录逻辑
- `tests/test_login.go` - 新增日志测试用例

**关键逻辑**:
- 在登录成功/失败的关键节点添加日志
- 使用结构化日志（JSON 格式）
- 避免记录敏感信息（如密码）

**依赖分析**:
- 依赖的 Story: STORY-03 (用户登录模块)
- 依赖的模块: 公司统一日志库 `common/logger`

**边界**:
- 禁止修改: 登录核心逻辑
- 接口约束: 不改变登录接口签名

**技术要点**:
- 使用 logger.Info() 记录成功，logger.Warn() 记录失败
- 日志字段: `user_id`, `username`, `ip`, `timestamp`, `result`, `reason`
- 敏感信息脱敏处理
```

### 示例 2: 子 Story - 性能优化

```markdown
---
id: STORY-05.1
type: hotfix
epic: EPIC-03
feature: FEAT-02
status: pending
created: 2025-12-22
depends_on:
  - STORY-05
---

# Story: 优化缓存查询性能

## 1. 目标

优化 Redis 缓存查询性能，减少网络往返次数，提升接口响应速度。

## 2. 验收标准（功能清单）

完成以下功能要求：

- [ ] 使用 Pipeline 批量查询缓存
- [ ] 缓存查询响应时间降低 30% 以上
- [ ] 功能行为保持不变（不引入新 bug）
- [ ] 单元测试覆盖率 ≥ 80%
- [ ] 性能测试验证：P95 响应时间 < 50ms
- [ ] 所有测试通过，代码通过 linter 检查

**验证方式**：
- 运行单元测试
- 运行性能测试对比优化前后
- 手动验证功能正常

## 3. 实现指导

**复杂度评估**: 2.0 分

**涉及文件**:
- `src/cache/redis_client.go` - 实现 Pipeline 批量查询
- `tests/test_cache.go` - 新增性能测试

**关键逻辑**:
- 收集所有需要查询的 key
- 使用 Redis Pipeline 批量执行 GET 命令
- 解析批量结果并返回

**依赖分析**:
- 依赖的 Story: STORY-05 (缓存模块)
- 依赖的模块: `redis-go` 客户端

**边界**:
- 禁止修改: 缓存接口定义
- 接口约束: 保持 Get() 方法签名不变

**技术要点**:
- 使用 redis.Pipeline() 创建管道
- 批量大小限制在 100 个 key（避免单次请求过大）
- 错误处理：任何 key 查询失败不影响其他 key
```

### 示例 3: 独立 Story - 配置调整

```markdown
---
id: STORY-06
type: hotfix
epic: EPIC-03
feature: FEAT-05
status: pending
created: 2025-12-22
depends_on: []
---

# Story: 调整 Redis 连接超时配置

## 1. 目标

调整 Redis 连接和读写超时配置，适应生产环境网络延迟，减少超时错误。

## 2. 验收标准（功能清单）

完成以下功能要求：

- [ ] 连接超时从 5s 调整为 10s
- [ ] 读超时从 3s 调整为 5s
- [ ] 写超时从 3s 调整为 5s
- [ ] 配置支持通过环境变量覆盖
- [ ] 手动验证：生产环境连接成功，无超时错误
- [ ] 代码通过 linter 检查

**验证方式**：
- 在测试环境验证配置生效
- 在生产环境观察超时错误率下降

## 3. 实现指导

**复杂度评估**: 1.0 分

**涉及文件**:
- `config/redis.yml` - 更新超时配置
- `src/config/redis_config.go` - 支持环境变量覆盖

**关键逻辑**:
- 修改配置文件中的 timeout 参数
- 添加环境变量读取逻辑（REDIS_CONNECT_TIMEOUT 等）

**依赖分析**:
- 无外部依赖

**边界**:
- 禁止修改: Redis 连接池其他配置
- 接口约束: 保持配置结构不变

**技术要点**:
- 配置单位：秒
- 环境变量优先级高于配置文件
- 默认值：连接超时 10s，读写超时 5s
```

### 示例 4: 独立 Story - 小功能添加

```markdown
---
id: STORY-07
type: hotfix
epic: EPIC-02
feature: FEAT-03
status: pending
created: 2025-12-22
depends_on: []
---

# Story: 增加健康检查端点

## 1. 目标

增加 HTTP 健康检查端点，便于负载均衡器和监控系统检测服务状态。

## 2. 验收标准（功能清单）

完成以下功能要求：

- [ ] 新增 GET /health 端点
- [ ] 返回 200 状态码和 JSON 格式响应
- [ ] 响应包含：服务状态、版本号、启动时间
- [ ] 检查核心依赖（数据库、Redis）连接状态
- [ ] 任何依赖不可用时返回 503 状态码
- [ ] 单元测试覆盖率 ≥ 80%
- [ ] 所有测试通过，代码通过 linter 检查

**验证方式**：
- 运行单元测试
- 手动访问 /health 端点验证
- 模拟依赖不可用场景测试

## 3. 实现指导

**复杂度评估**: 1.8 分

**涉及文件**:
- `src/api/health.go` - 实现健康检查逻辑
- `src/api/router.go` - 注册路由
- `tests/test_health.go` - 单元测试

**关键逻辑**:
- 实现 HealthCheckHandler
- 依次检查数据库、Redis 连接
- 返回 JSON 格式：`{"status": "ok", "version": "1.0.0", "uptime": "123s"}`

**依赖分析**:
- 依赖的模块: 数据库连接池、Redis 客户端

**边界**:
- 禁止修改: 现有 API 路由
- 接口约束: 健康检查不需要认证

**技术要点**:
- 响应格式：`{"status": "ok|degraded|down", "checks": {...}}`
- 超时控制：每个依赖检查超时 1s
- 并发检查：使用 goroutine 并行检查多个依赖
```

---

## 注意事项

### 关于测试

**本 Playbook 生成的 Hotfix Story 使用单元测试验证**：

- ✅ 每个 Hotfix 应该规划单元测试
- ✅ 在功能清单中明确测试覆盖率要求
- ❌ 不使用 BDD 场景（BDD 用于 E2E Story）

### 关于复杂度

如果评估发现复杂度 > 2.0 分，应该：
1. 提示用户："该变更复杂度较高，建议创建标准 Story"
2. 询问用户是否继续创建 Hotfix 或改用标准 Story
3. 如果用户坚持，可以创建但在文档中注明风险

### 关于依赖和边界

即使是简单的 Hotfix，也必须明确：
- **依赖关系**：避免遗漏依赖导致无法执行
- **修改边界**：避免改动扩散影响其他模块
- **技术要点**：关键的注意事项，避免引入新问题

这些是质量保证的关键要素，不能省略。

---

现在，请根据用户提供的信息或 quick_router.md 传递的信息，生成 Hotfix Story。

