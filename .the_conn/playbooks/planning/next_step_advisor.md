# 下一步行动顾问 (Next Step Advisor)

## 用途

当用户不确定下一步应该规划什么 Story 或执行什么任务时，调用此 Playbook。AI 会分析当前项目状态，智能建议下一步行动。

## ⚠️ 重要：遵守基础公约

**本 Playbook 严格遵守 `@rules/base_rules.md` 中定义的所有基础公约。**

**📋 规范引用**：

本 Playbook 依赖以下规范文件（AI 必须先加载）：
- **基础公约**: `@rules/base_rules.md` - 禁止事项、文件路径约定、质量标准
- **测试策略**: `@rules/test_strategy_rules.md` - 用于判断是否需要补充测试 Story

**原因**: next_step_advisor 需要分析项目状态并建议下一步行动，包括测试策略建议

---

## 使用场景

用户可以随时询问：

- "我下一步该做什么？"
- "现在应该规划什么 Story？"
- "Feature 开发到什么程度了？"
- "是否需要补充测试？"

---

## AI 分析流程

### Step 1: 收集当前状态信息

| 信息类别             | 收集内容                                                             | 目的           |
| --- | --- | --- |
| **Epic/Feature结构** | 当前活跃Epic/下属Feature/包含Story                                   | 确定项目层级   |
| **Story完成状态**    | 统计status字段(pending/done)<br/>检查depends_on                      | 识别进度和阻塞 |
| **测试覆盖情况**     | E2E测试(type:e2e_test)<br/>性能测试(type:perf_test)<br/>单元测试计划 | 评估质量保障   |
| **最近代码变更**     | 修改的文件/技术债                                                    | 发现潜在问题   |

### Step 2: 智能分析与建议

根据不同场景，给出定制化建议（见场景分析）。

---

## 场景分析与建议模板（精简对比）

| 场景                  | 检测条件                                  | 输出关键内容                                                                           | 下一步建议要点                                                                                                                |
| --- | --- | --- | --- |
| **1.Feature刚启动**   | 1-2个Story<br/>均为pending                | ✅已完成:创建Feature+规划Story<br/>🔍分析:功能Story齐全/缺E2E测试<br/>📊预计Story数:3-5个 | 1.规划剩余功能Story<br/>2.添加STORY-99 E2E测试<br/>3.确认依赖关系<br/>4.开始第一个Story                                       |
| **2.Feature开发中**   | 部分done<br/>部分pending                  | ✅已完成:STORY-01,02<br/>🚧待开发:STORY-03,04<br/>📊进度:50%(2/4)                         | 1.继续STORY-03（依赖已满足）<br/>2.并行STORY-04（无依赖）<br/>3.功能完成后执行STORY-99                                        |
| **3.Feature接近完成** | 大部分done<br/>剩0-2个                    | ✅已完成:STORY-01-04<br/>🚧待完成:STORY-99 E2E<br/>📊进度:80%(4/5)                        | 1.立即执行STORY-99 E2E测试<br/>2.验证完整流程<br/>3.准备Feature验收<br/>4.考虑Epic级测试（如是最后Feature）                   |
| **4.检测到技术债**    | 标题含Refactor<br/>无回归测试             | ⚠️问题:STORY-03 Refactor无测试<br/>🔍分析:重构无测试可能引入Bug                          | 1.补充单元测试覆盖<br/>2.考虑STORY-03.1回归测试<br/>3.确保BDD测试通过<br/>🛡️高优先级:先测试后重构                              |
| **5.Epic级别统览**    | Epic有多个Feature<br/>需整体评估          | 📊Feature进度总览表<br/>整体进度:58%(7/12)<br/>测试覆盖:2/3 Feature E2E                 | 1.继续FEAT-02剩余Story<br/>2.为FEAT-03规划测试Story<br/>3.规划Epic E2E:STORY-999<br/>4.设置测试里程碑                         |
| **6.缺少测试Story**   | Feature≥3个功能Story<br/>无97-99测试Story | ⚠️问题:FEAT-02有4个功能Story<br/>无E2E测试<br/>集成复杂度:高                            | 1.添加STORY-99 E2E<br/>2.规划测试场景:Happy Path/Error Handling/Data Consistency<br/>⏰最佳时机:现在规划（开发参考，避免返工） |

**输出格式要求**（所有场景必须包含）:

1. 📍当前状态概述
2. ✅已完成项列表
3. 🚧进行中/待办项
4. 🔍智能分析
5. 💡具体建议（可执行）
6. 🎯优先级标注
7. ⚠️风险提示（如有）

---

## 调用示例

| 场景            | 用户输入                              | AI行动                                                                                            |
| --- | --- | --- |
| 通用询问        | "我下一步该做什么？"                  | 1.读取`.the_conn/epics/`<br/>2.分析Epic/Feature/Story状态<br/>3.匹配场景模板<br/>4.输出定制化建议 |
| 特定Feature询问 | "FEAT-02现在进展如何？下一步做什么？" | 1.定位FEAT-02目录<br/>2.统计Story完成情况<br/>3.检查测试覆盖<br/>4.输出Feature专属建议            |

---

## AI 分析检查清单

| 检查项                       | 说明 |
| --- | --- |
| ✅ 读取Epic/Feature/Story文件 | -    |
| ✅ 解析Frontmatter状态        | -    |
| ✅ 统计完成进度               | -    |
| ✅ 检测测试覆盖               | -    |
| ✅ 识别依赖关系和阻塞         | -    |
| ✅ 匹配场景模板               | -    |
| ✅ 输出可执行建议             | -    |
| ✅ 标注优先级和时间           | -    |

---

## 注意事项

| 原则               | 说明                    | 示例                           |
| --- | --- | --- |
| **建议具体可执行** | 不只说"继续开发"        | "开发STORY-03，因为依赖已满足" |
| **优先级明确**     | 高/中/低，帮助决策      | -                              |
| **考虑依赖关系**   | 检查`depends_on`字段    | 避免建议有阻塞的Story          |
| **测试覆盖检查**   | 主动提醒缺失的测试Story | -                              |
| **里程碑感知**     | 告知当前阶段和完成进度  | "距离Feature完成还有2个Story"  |

---

现在，请分析项目当前状态，给出下一步行动建议。
